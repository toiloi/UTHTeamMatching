<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Chat báº¡n bÃ¨</title>
  <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
  <style>
    #chat-box {
      height: 400px;
      overflow-y: scroll;
      border: 1px solid #ccc;
      padding: 10px;
      background-color: #f8f9fa;
    }
  </style>
</head>
<body>
<div class="container mt-4">
  <h3>Chat vá»›i <span th:text="${friend.getHo() + ' '+friend.getTen()}"></span></h3>

  <div id="chat-box" class="mb-3"></div>

  <form id="chat-form" class="d-flex">
    <input type="text" id="messageInput" class="form-control me-2" placeholder="Nháº­p tin nháº¯n...">
    <input type="hidden" name="friendId" th:value="${friend.getMaSo()}" />
    <button type="button" id="send-button">Gá»­i</button>
  </form>

</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

<script th:inline="javascript">

  const currentUserId = [[${currentUser.getMaSo()}]];
  const friendId = [[${friend.getMaSo()}]];

  let stompClient = null;
  let isConnected = false;

  function connectWebSocket(currentUserId) {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
      console.log('âœ… Connected: ' + frame);
      isConnected = true;

      // Pháº£i enable nÃºt gá»­i sau khi káº¿t ná»‘i
      document.getElementById("send-button").disabled = false;

      stompClient.subscribe(`/topic/messages.user-${currentUserId}`, function (messageOutput) {
        const msg = JSON.parse(messageOutput.body);
        displayMessage(msg);
      });
    });


  }

  function sendMessage(senderId, receiverId) {
    if (!isConnected || !stompClient) {
      alert("â³ Äang káº¿t ná»‘i... Vui lÃ²ng thá»­ láº¡i sau vÃ i giÃ¢y.");
      return;
    }

    const content = document.getElementById("messageInput").value;

    const message = {
      senderId: senderId,
      receiverId: receiverId,
      content: content
    };

    console.log("âœ… Sending message:", message);
    stompClient.send("/app/chat", {}, JSON.stringify(message));
    document.getElementById('messageInput').value = '';
  }

  function displayMessage(msg) {
    console.log("Displaying message: ", msg);  // Log tin nháº¯n Ä‘á»ƒ kiá»ƒm tra

    const chatBox = document.getElementById("chat-box");
    const div = document.createElement("div");
    div.innerText = `[${msg.senderName}] ${msg.content}`;  // Hiá»ƒn thá»‹ tÃªn ngÆ°á»i gá»­i vÃ  ná»™i dung tin nháº¯n
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;  // Cuá»™n xuá»‘ng dÆ°á»›i khi cÃ³ tin nháº¯n má»›i
  }


  function loadMessages() {
    fetch(`/getMessages?senderId=${currentUserId}&receiverId=${friendId}`)
            .then(response => response.json())
            .then(messages => {
              console.log("ðŸ’¬ Loaded messages from DB:", messages);
              messages.forEach(msg => {
                displayMessage(msg);
              });
            })
            .catch(error => console.error('Error loading messages:', error));
  }

  document.addEventListener("DOMContentLoaded", function () {
    // Disable nÃºt gá»­i lÃºc Ä‘áº§u
    document.getElementById("send-button").disabled = true;

    // Load tin nháº¯n tá»« database
    loadMessages();

    // Káº¿t ná»‘i WebSocket
    connectWebSocket(currentUserId);

    // Gáº¯n sá»± kiá»‡n gá»­i khi báº¥m nÃºt gá»­i
    document.getElementById("send-button").addEventListener("click", function () {
      sendMessage(currentUserId, friendId);
    });
  });

</script>

</body>
</html>
